<head>
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  />
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
            /* --- CSS untuk Modal --- */
        .modal {
            display: none; /* Sembunyikan modal secara default */
            position: fixed; /* Tetap di posisi yang sama bahkan saat di-scroll */
            z-index: 1; /* Di atas elemen lain */
            left: 0;
            top: 0;
            width: 100%; /* Lebar penuh */
            height: 100%; /* Tinggi penuh */
            overflow: auto; /* Aktifkan scroll jika konten terlalu besar */
            background-color: rgba(0,0,0,0.4); /* Warna latar belakang transparan */
            justify-content: center; /* Pusatkan secara horizontal */
            align-items: center; /* Pusatkan secara vertikal */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Lebar konten modal */
            max-width: 500px; /* Lebar maksimum konten modal */
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        /* Animasi masuk modal */
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .checkbox-item {
            margin-bottom: 10px;
        }

        .checkbox-item label {
            margin-left: 5px;
        }

        /* --- CSS untuk Tombol Pembuka Modal --- */
        #openModalBtn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 50px;
            margin-left: 50px;
        }
  </style>
</head>

<h2>Daftar Transaksi</h2>

<table
  border="1"
  cellpadding="5"
  cellspacing="0"
  id="tableTransaksi"
  class="display"
>
  <thead><th>Nama Klien</th><th>Tanggal</th></thead>
  <tbody></tbody>
</table>

<h3>Filter Data</h3>
<form id="filterForm">
  <label>Nama Klien:</label>
  <select name="nama_klien" multiple class="select2" style="width: 200px">
    <option></option>
  </select>

  <label>Tanggal:</label>
  <select name="tanggal" multiple class="select2" style="width: 200px">
    <option></option>
  </select>
</form>
<!-- Include jQuery & Select2 -->
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
  $(document).ready(function () {
    // Inisialisasi Select2
    $(".select2").select2({
      width: "200px",
      placeholder: "Pilih",
    });

    let dataTable; // ‚Üê Ini boleh di luar atau di dalam ready()

    function loadData() {
      const formData = $("#filterForm").serialize();

      $.ajax({
        url: window.location.pathname,
        data: formData,
        dataType: "json",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        success: function (response) {
          // Update dropdown
          const klienSelect = $('select[name="nama_klien"]');
          const selectedKlien = klienSelect.val() || [];
          klienSelect.empty();
          (response.opsi_dropdown.nama_klien || []).forEach(function (klien) {
            const selected = selectedKlien.includes(klien) ? "selected" : "";
            klienSelect.append(
              `<option value="${klien}" ${selected}>${klien}</option>`
            );
          });
          klienSelect.trigger("change.select2");

          const tanggalSelect = $('select[name="tanggal"]');
          const selectedTanggal = tanggalSelect.val() || [];
          tanggalSelect.empty();
          (response.opsi_dropdown.tanggal || []).forEach(function (tgl) {
            const selected = selectedTanggal.includes(tgl) ? "selected" : "";
            tanggalSelect.append(
              `<option value="${tgl}" ${selected}>${tgl}</option>`
            );
          });
          tanggalSelect.trigger("change.select2");

          // Update DataTable
          if (dataTable) {
            dataTable.clear().rows.add(response.data).draw();
          } else {
            dataTable = $("#tableTransaksi").DataTable({
              data: response.data,
              columns: [
                { data: "nama_klien" },
                { data: "tanggal"},
              ],
              destroy: true,
              searching: true,
              paging: true,
              ordering: true,
            });
          }
        },
        error: function () {
          alert("Terjadi kesalahan saat memuat data.");
        },
      });
    }

    // Event handler saat dropdown berubah
    $("#filterForm select").on("change", function () {
      loadData();
    });

    // Load data pertama kali saat halaman dibuka
    loadData();
  });
  

          // --- JavaScript untuk Modal ---
        const modal = document.getElementById("myModal");
        const btn = document.getElementById("openModalBtn");
        const span = document.getElementsByClassName("close-button")[0];
        const submitBtn = document.getElementById("submitSelection");

        // Ketika user mengklik tombol, buka modal
        btn.onclick = function() {
            modal.style.display = "flex"; // Menggunakan flex untuk memusatkan modal
        }

        // Ketika user mengklik <span> (x), tutup modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // Ketika user mengklik di luar modal, tutup modal
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Ketika user mengklik tombol "Kirim Pilihan"
        submitBtn.onclick = function() {
            const checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]:checked');
            const selectedOptions = [];
            checkboxes.forEach(checkbox => {
                selectedOptions.push(checkbox.value);
            });

            if (selectedOptions.length > 0) {
                alert("Anda memilih: " + selectedOptions.join(", "));
            } else {
                alert("Tidak ada opsi yang dipilih.");
            }
            modal.style.display = "none"; // Tutup modal setelah submit
        }
</script>
